<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Transcribe Audio - Whisper API</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/wavesurfer.js@7"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="/static/translations.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'dark-bg': '#0b1220',
            'dark-panel': '#111827',
            'dark-border': '#1f2937',
          }
        }
      }
    }
  </script>
  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .animate-spin {
      animation: spin 1s linear infinite;
    }
  </style>
</head>
<body class="bg-dark-bg text-gray-100 min-h-screen flex flex-col">
  <div class="container mx-auto max-w-5xl px-4 py-8 flex-grow">
    <!-- Header -->
    <header class="flex items-center justify-between mb-8">
      <div class="flex items-center gap-3">
        <img src="/static/images/psi-lab.jpg" alt="PSI Lab" class="h-10 w-10 rounded-lg" />
        <h1 class="text-2xl font-bold text-white" data-i18n="appTitle">Audio Transcription</h1>
      </div>
      <div class="flex items-center gap-3">
        <!-- Language Toggle -->
        <div class="flex gap-1 bg-dark-panel rounded-lg p-1 border border-dark-border">
          <button id="lang-vn" class="px-2 py-1 rounded transition-colors text-gray-400 hover:bg-gray-600" onclick="switchLanguage('vi')" aria-label="Tiếng Việt">
            <svg class="w-5 h-4" viewBox="0 0 30 20" fill="none">
              <rect width="30" height="20" fill="#DA251D"/>
              <path d="M15 4L16.854 9.764H22.929L17.537 13.472L19.391 19.236L15 15.528L10.609 19.236L12.463 13.472L7.071 9.764H13.146L15 4Z" fill="#FFCD00"/>
            </svg>
          </button>
          <button id="lang-en" class="px-2 py-1 rounded transition-colors bg-white text-gray-900" onclick="switchLanguage('en')" aria-label="English">
            <svg class="w-5 h-4" viewBox="0 0 30 20" fill="none">
              <rect width="30" height="20" fill="#012169"/>
              <path d="M0 0L30 20M30 0L0 20" stroke="white" stroke-width="4"/>
              <path d="M0 0L30 20M30 0L0 20" stroke="#C8102E" stroke-width="2.5"/>
              <path d="M15 0V20M0 10H30" stroke="white" stroke-width="6"/>
              <path d="M15 0V20M0 10H30" stroke="#C8102E" stroke-width="4"/>
            </svg>
          </button>
        </div>
        <div id="status-pill" class="flex items-center gap-2 px-3 py-1.5 bg-emerald-950/40 text-emerald-400 text-sm font-medium rounded-full border border-emerald-400/20">
          <div class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></div>
          <span data-i18n="online">Online</span>
        </div>
      </div>
    </header>

    <!-- Main Card -->
    <div class="bg-dark-panel border border-dark-border rounded-xl shadow-2xl overflow-hidden">
      <!-- Upload Section -->
      <div class="p-6 border-b border-dark-border">
        <div class="space-y-5">
          <!-- File Upload -->
          <div>
            <label for="audio" class="block text-sm font-medium text-gray-400 mb-2">
              <i data-lucide="upload" class="w-4 h-4 inline mr-1"></i>
              <span data-i18n="audioFile">Audio File</span>
            </label>
            <div class="relative">
              <input 
                id="audio" 
                name="file" 
                type="file" 
                accept="audio/wav,audio/mp3,audio/mpeg" 
                class="block w-full text-sm text-gray-400 file:mr-4 file:py-2.5 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 file:cursor-pointer cursor-pointer bg-gray-900/50 border border-dark-border rounded-lg disabled:opacity-50 disabled:cursor-not-allowed file:disabled:bg-gray-600 file:disabled:cursor-not-allowed"
              />
            </div>
            <p class="mt-2 text-xs text-gray-500" data-i18n="supportedFormats">Supported formats: .wav, .mp3</p>
          </div>

          <!-- Waveform Display -->
          <div id="waveform-container" class="hidden">
            <div class="bg-gray-900/50 rounded-lg p-4 border border-dark-border">
              <div id="waveform"></div>
              <div class="flex items-center justify-between mt-3 text-sm text-gray-400">
                <button id="playPauseBtn" class="flex items-center gap-2 px-3 py-1.5 bg-gray-800 hover:bg-gray-700 rounded-lg transition">
                  <i data-lucide="play" class="w-4 h-4"></i>
                  <span data-i18n="play">Play</span>
                </button>
                <span id="waveformTime">0:00 / 0:00</span>
              </div>
            </div>
          </div>

          <!-- Language Selector -->
          <div>
            <label for="language" class="block text-sm font-medium text-gray-400 mb-2">
              <i data-lucide="languages" class="w-4 h-4 inline mr-1"></i>
              <span data-i18n="language">Language</span>
            </label>
            <select 
              id="language" 
              name="language" 
              class="block w-full px-4 py-2.5 bg-gray-900/50 border border-dark-border text-gray-100 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="vi" selected data-i18n="vietnameseVi">Vietnamese (vi)</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="p-6 bg-gray-900/30">
        <div class="flex flex-wrap items-center gap-3">
          <button 
            id="btnTranscribe" 
            type="button" 
            class="flex items-center gap-2 px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition shadow-lg hover:shadow-blue-500/50 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <i data-lucide="zap" class="w-5 h-5"></i>
            <span data-i18n="generateTranscript">Generate Transcript</span>
          </button>
          <button 
            id="btnReset" 
            type="button" 
            class="flex items-center gap-2 px-6 py-2.5 bg-transparent hover:bg-gray-800 text-gray-300 font-semibold rounded-lg border border-dark-border transition disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-transparent"
          >
            <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
            <span data-i18n="reset">Reset</span>
          </button>
          <div id="progress" class="hidden items-center gap-2 text-gray-400">
            <svg class="animate-spin h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span data-i18n="transcribing">Transcribing…</span>
          </div>
        </div>
        <div id="error" class="hidden mt-4 p-3 bg-red-950/40 border border-red-500/30 text-red-400 rounded-lg" role="alert"></div>
      </div>

      <!-- Result Section -->
      <div class="p-6 border-t border-dark-border">
        <div class="flex items-center justify-between mb-3">
          <label class="text-sm font-medium text-gray-400">
            <i data-lucide="file-text" class="w-4 h-4 inline mr-1"></i>
            <span data-i18n="transcribedText">Transcribed Text</span>
          </label>
          <div class="flex items-center gap-2">
            <button 
              id="btnDownload" 
              class="hidden items-center gap-1 px-3 py-1 text-xs text-gray-400 hover:text-white bg-gray-800 hover:bg-gray-700 rounded transition"
            >
              <i data-lucide="download" class="w-3 h-3"></i>
              <span data-i18n="downloadTxt">Download TXT</span>
            </button>
            <button 
              id="btnCopy" 
              class="flex items-center gap-1 px-3 py-1 text-xs text-gray-400 hover:text-white bg-gray-800 hover:bg-gray-700 rounded transition"
            >
              <i data-lucide="copy" class="w-3 h-3"></i>
              <span data-i18n="copy">Copy</span>
            </button>
          </div>
        </div>
        <pre id="resultJson" class="bg-gray-950 border border-dark-border rounded-lg p-4 text-sm text-gray-300 overflow-x-auto max-h-96 whitespace-pre-wrap" data-i18n="notTranscribedYet">Not transcribed yet</pre>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="mt-6 py-4 bg-dark-panel border-t border-dark-border">
    <div class="container mx-auto max-w-5xl px-4">
      <div class="flex flex-col items-center gap-3">
        <p class="text-gray-400 text-sm font-medium" data-i18n="copyright">Psi Technology © 2025</p>
        <div class="flex gap-3">
          <a href="https://xechohang.vn/" target="_blank" rel="noopener noreferrer" 
             class="w-14 h-14 flex items-center justify-center rounded-full bg-gray-800 hover:bg-gray-700 transition-colors overflow-hidden">
            <img src="/static/images/psi-lab.jpg" alt="Xe Cho Hang" width="32" height="32" class="rounded-sm object-cover" />
          </a>
          <a href="https://www.facebook.com/psi.lab.vn" target="_blank" rel="noopener noreferrer" 
             class="w-14 h-14 flex items-center justify-center rounded-full bg-gray-800 hover:bg-gray-700 transition-colors">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="#1877F2">
              <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
            </svg>
          </a>
          <a href="https://www.tiktok.com/@xedien6969" target="_blank" rel="noopener noreferrer" 
             class="w-14 h-14 flex items-center justify-center rounded-full bg-gray-800 hover:bg-gray-700 transition-colors">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="#ffffff">
              <path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-1.43.08-2.86-.31-4.08-1.03-2.02-1.19-3.44-3.37-3.65-5.71-.02-.5-.03-1-.01-1.49.18-1.9 1.12-3.72 2.58-4.96 1.66-1.44 3.98-2.13 6.15-1.72.02 1.48-.04 2.96-.04 4.44-.99-.32-2.15-.23-3.02.37-.63.41-1.11 1.04-1.36 1.75-.21.51-.15 1.07-.14 1.61.24 1.64 1.82 3.02 3.5 2.87 1.12-.01 2.19-.66 2.77-1.61.19-.33.4-.67.41-1.06.1-1.79.06-3.57.07-5.36.01-4.03-.01-8.05.02-12.07z"/>
            </svg>
          </a>
          <a href="https://www.youtube.com/@xedienchohangvn" target="_blank" rel="noopener noreferrer" 
             class="w-14 h-14 flex items-center justify-center rounded-full bg-gray-800 hover:bg-gray-700 transition-colors">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="#FF0000">
              <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
            </svg>
          </a>
        </div>
      </div>
    </div>
  </footer>

  <script>
    // Initialize Lucide icons
    lucide.createIcons();

    const apiBase = window.location.origin.includes(":8001") ? window.location.origin : "http://localhost:8001";
    const $audio = document.getElementById('audio');
    const $language = document.getElementById('language');
    const $btnTranscribe = document.getElementById('btnTranscribe');
    const $btnReset = document.getElementById('btnReset');
    const $btnCopy = document.getElementById('btnCopy');
    const $btnDownload = document.getElementById('btnDownload');
    const $progress = document.getElementById('progress');
    const $error = document.getElementById('error');
    const $resultJson = document.getElementById('resultJson');
    const $waveformContainer = document.getElementById('waveform-container');
    const $playPauseBtn = document.getElementById('playPauseBtn');
    const $waveformTime = document.getElementById('waveformTime');

    let wavesurfer = null;
    let currentTranscription = null;

    // Persist language choice
    const savedLang = localStorage.getItem('transcribe_lang');
    if (savedLang) $language.value = savedLang;
    $language.addEventListener('change', () => localStorage.setItem('transcribe_lang', $language.value));

    // Initialize WaveSurfer
    function initWaveSurfer() {
      if (wavesurfer) {
        wavesurfer.destroy();
      }
      
      wavesurfer = WaveSurfer.create({
        container: '#waveform',
        waveColor: '#4f46e5',
        progressColor: '#818cf8',
        cursorColor: '#c7d2fe',
        barWidth: 2,
        barGap: 1,
        height: 80,
        normalize: true,
        backend: 'WebAudio'
      });

      wavesurfer.on('ready', () => {
        updateTimeDisplay();
      });

      wavesurfer.on('audioprocess', () => {
        updateTimeDisplay();
      });

      wavesurfer.on('finish', () => {
        $playPauseBtn.querySelector('span').textContent = t('play');
        updatePlayIcon('play');
      });

      return wavesurfer;
    }

    function updateTimeDisplay() {
      if (!wavesurfer) return;
      const current = formatTime(wavesurfer.getCurrentTime());
      const duration = formatTime(wavesurfer.getDuration());
      $waveformTime.textContent = `${current} / ${duration}`;
    }

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function updatePlayIcon(state) {
      const icon = $playPauseBtn.querySelector('i');
      icon.setAttribute('data-lucide', state);
      lucide.createIcons();
    }

    // Handle file selection
    $audio.addEventListener('change', async () => {
      hideError();
      const file = $audio.files && $audio.files[0];
      
      if (!file) {
        $waveformContainer.classList.add('hidden');
        return;
      }

      // Show waveform
      $waveformContainer.classList.remove('hidden');
      
      // Load audio into WaveSurfer
      if (!wavesurfer) {
        initWaveSurfer();
      }
      
      const url = URL.createObjectURL(file);
      wavesurfer.load(url);
    });

    // Play/Pause control
    $playPauseBtn.addEventListener('click', () => {
      if (!wavesurfer) return;
      
      if (wavesurfer.isPlaying()) {
        wavesurfer.pause();
        $playPauseBtn.querySelector('span').textContent = t('play');
        updatePlayIcon('play');
      } else {
        wavesurfer.play();
        $playPauseBtn.querySelector('span').textContent = t('pause');
        updatePlayIcon('pause');
      }
    });

    // Copy to clipboard
    $btnCopy.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText($resultJson.textContent);
        const originalText = $btnCopy.innerHTML;
        $btnCopy.innerHTML = '<i data-lucide="check" class="w-3 h-3"></i> <span data-i18n="copied">' + t('copied') + '</span>';
        lucide.createIcons();
        setTimeout(() => {
          $btnCopy.innerHTML = originalText;
          lucide.createIcons();
        }, 2000);
      } catch (err) {
        console.error('Failed to copy:', err);
      }
    });

    // Download as text file
    $btnDownload.addEventListener('click', () => {
      if (!currentTranscription) return;
      
      // Create blob and download with the text content from API
      const blob = new Blob([currentTranscription.text], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const filename = currentTranscription.filename.replace(/\.wav$/i, '');
      a.download = `${filename}_transcription.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    function showError(message) {
      $error.textContent = message;
      $error.classList.remove('hidden');
      $error.classList.add('flex');
    }

    function showErrorKey(key) {
      $error.textContent = t(key);
      $error.classList.remove('hidden');
      $error.classList.add('flex');
    }

    function hideError() {
      $error.classList.add('hidden');
      $error.classList.remove('flex');
    }

    async function transcribe() {
      hideError();
      const file = $audio.files && $audio.files[0];
      
      if (!file) {
        showErrorKey('errorSelectFile');
        return;
      }
      
      const fileName = file.name.toLowerCase();
      if (!fileName.endsWith('.wav') && !fileName.endsWith('.mp3')) {
        showErrorKey('errorUnsupportedFormat');
        return;
      }

      const form = new FormData();
      form.append('file', file);
      form.append('language', $language.value || 'vi');

      $progress.classList.remove('hidden');
      $progress.classList.add('flex');
      $btnTranscribe.disabled = true;
      $btnReset.disabled = true;
      $audio.disabled = true;

      try {
        const res = await fetch(`${apiBase}/transcribe`, {
          method: 'POST',
          body: form
        });
        
        if (!res.ok) {
          const errorData = await res.json().catch(() => ({ detail: t('errorTranscriptionFailed') }));
          showError(errorData.detail || t('errorTranscriptionFailed'));
          $btnDownload.classList.add('hidden');
          $btnDownload.classList.remove('flex');
          currentTranscription = null;
        } else {
          // Get text response
          const textContent = await res.text();
          $resultJson.textContent = textContent;
          
          // Store transcription data and show download button
          currentTranscription = {
            text: textContent,
            filename: file.name
          };
          $btnDownload.classList.remove('hidden');
          $btnDownload.classList.add('flex');
        }
      } catch (err) {
        showError(t('errorNetwork') + ' ' + err.message);
        $btnDownload.classList.add('hidden');
        $btnDownload.classList.remove('flex');
        currentTranscription = null;
      } finally {
        $progress.classList.add('hidden');
        $progress.classList.remove('flex');
        $btnTranscribe.disabled = false;
        $btnReset.disabled = false;
        $audio.disabled = false;
      }
    }

    function resetForm() {
      $audio.value = '';
      $waveformContainer.classList.add('hidden');
      if (wavesurfer) {
        wavesurfer.stop();
        wavesurfer.empty();
      }
      $resultJson.textContent = t('notTranscribedYet');
      hideError();
      $btnDownload.classList.add('hidden');
      $btnDownload.classList.remove('flex');
      currentTranscription = null;
    }

    $btnTranscribe.addEventListener('click', transcribe);
    $btnReset.addEventListener('click', resetForm);
  </script>
</body>
</html>
